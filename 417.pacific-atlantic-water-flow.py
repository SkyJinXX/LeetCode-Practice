#
# @lc app=leetcode id=417 lang=python3
#
# [417] Pacific Atlantic Water Flow
#

# @lc code=start
# Wrong Answer
# [[12,9,18,4,1,4,8,8,9,7,15,17,2,17,17],[1,0,17,15,11,10,10,7,8,1,16,10,11,14,19],[0,19,7,4,9,6,4,5,4,7,0,13,3,16,6],[18,18,10,16,12,13,3,6,11,5,7,5,16,15,19],[0,9,16,15,17,11,1,1,17,14,2,11,18,0,6],[14,18,2,10,2,0,8,0,11,10,4,16,1,10,19],[5,16,3,4,5,10,5,14,15,15,18,0,15,12,15],[4,8,8,14,18,6,15,9,18,6,16,12,14,7,18],[9,13,16,15,5,9,16,18,8,0,18,7,10,10,13],[5,0,8,9,16,2,8,5,5,3,14,12,4,19,19],[6,13,10,5,0,15,9,3,8,13,6,3,12,17,16],[9,18,3,13,10,1,12,6,19,11,6,13,17,14,1],[19,2,10,15,11,13,16,3,14,6,9,7,17,6,11],[14,14,3,1,14,17,5,19,7,2,12,0,8,0,13],[7,14,11,4,6,3,15,0,17,5,18,7,8,18,8],[8,0,4,15,19,11,9,1,16,12,17,18,1,1,3],[3,2,1,11,9,19,10,10,12,1,19,9,7,5,8],[12,17,10,11,13,15,14,3,5,12,9,16,10,6,2],[1,17,6,18,2,8,16,7,6,16,18,14,2,5,19],[1,17,13,0,13,15,3,14,3,9,18,7,2,2,19],[3,14,4,12,3,8,19,9,0,11,7,1,14,1,13],[6,9,14,3,2,10,7,1,12,3,7,1,15,1,13],[0,18,19,5,14,0,12,4,19,11,13,19,12,16,4],[19,6,13,9,9,15,7,19,5,5,11,12,13,8,1],[7,4,4,1,15,4,12,18,1,1,8,16,19,16,1],[10,15,16,11,1,11,17,8,12,14,19,19,0,8,5],[0,8,8,8,7,19,3,6,9,10,11,9,12,2,2],[9,11,14,12,16,13,18,14,2,14,0,12,9,11,0],[3,16,0,15,1,9,1,0,12,3,10,12,5,18,4],[12,6,18,12,9,2,7,19,4,16,17,9,12,4,10]]
# Wrong
# [[38,9,45,34,21,55,15,31,12,96,36,96,47,69,29,96,74,77,58,58,16,52,23,27,99,65,79,70,53,60,75,42,52,18,87,30,55,69,98,12,9,33,91,41,6,9,17,70,96,28,47,27,12,80,65,76,3,8,87,25,97,62,8,40,97,28,56,51,22,84,86,35,49,76,90,51,59,76,11,66,76,83,45,36,48,88,37,77,65,68,90,44,73,54,76,87,56],[76,72,12,7,66,80,23,73,66,33,11,19,73,3,0,32,37,88,51,66,88,1,86,40,97,14,54,9,66,61,53,98,89,71,70,84,41,31,97,89,70,36,61,61,18,90,96,57,86,80,93,67,56,97,25,81,50,48,56,77,96,51,28,86,32,33,77,63,55,84,67,48,9,59,49,61,2,47,23,66,75,61,74,32,88,44,56,16,76,53,42,54,75,9,0,50,45],[10,56,86,70,54,19,3,6,69,82,3,4,58,8,96,12,6,17,56,52,30,78,52,78,31,80,87,43,27,83,91,2,85,81,7,0,21,5,42,82,76,33,3,6,12,43,31,56,53,11,67,56,39,64,34,24,55,6,79,87,33,27,44,74,32,98,65,40,26,63,48,1,6,82,10,43,57,60,62,36,93,0,25,52,37,84,34,0,57,71,72,89,76,31,95,19,97],[92,40,65,57,67,58,94,93,33,26,55,63,24,42,31,53,36,42,44,21,64,51,95,56,20,46,60,96,36,37,53,86,94,73,61,12,76,28,93,99,1,97,77,57,82,79,38,90,87,30,65,89,67,38,8,78,17,19,16,96,4,85,73,69,42,34,39,5,31,93,39,25,28,26,87,92,6,56,0,29,60,38,25,32,74,31,88,90,42,64,37,60,9,77,99,55,62],[81,39,64,10,18,48,83,24,5,92,10,1,94,70,96,16,97,49,27,96,61,66,31,34,86,95,25,2,42,58,65,75,56,84,60,55,47,59,49,34,26,4,34,54,57,35,28,55,63,25,13,61,29,88,23,87,0,78,86,60,7,11,81,29,21,8,61,25,19,25,19,29,49,75,1,41,32,32,41,97,16,98,27,45,3,62,0,47,66,50,71,58,50,13,56,24,92],[94,20,77,43,57,97,63,55,13,70,99,52,65,43,73,64,14,51,41,22,9,99,35,44,27,37,32,12,96,85,31,99,66,84,50,54,47,50,30,67,54,26,26,64,17,22,81,91,27,84,96,79,8,44,90,58,1,43,90,52,14,86,27,99,64,37,36,66,93,36,15,84,30,16,12,18,20,89,27,70,43,79,2,17,64,52,94,44,96,94,13,7,88,10,84,21,76],[32,31,84,4,86,46,48,21,16,5,8,11,26,0,11,27,47,11,57,61,36,45,47,48,57,32,93,85,40,90,55,26,73,36,63,19,31,54,79,15,43,83,82,98,35,31,84,12,65,32,59,34,67,12,90,25,45,23,5,30,78,88,31,82,14,94,89,91,76,21,19,61,92,84,13,64,34,74,24,40,27,72,47,44,8,90,73,31,37,62,40,6,78,76,36,36,10],[45,47,43,61,93,17,49,64,47,89,33,5,27,51,93,32,4,12,50,71,21,24,38,61,54,78,91,50,40,67,88,54,9,12,81,71,23,26,80,22,76,38,66,53,27,81,30,61,74,67,0,75,19,11,3,50,14,55,21,28,85,38,94,48,35,78,45,92,87,65,26,3,0,55,79,95,90,63,66,61,88,87,7,74,33,58,20,71,27,98,13,53,58,58,86,47,70],[58,52,17,32,58,32,85,50,9,39,69,7,83,75,45,37,49,47,10,83,78,50,84,19,43,42,5,25,24,5,36,54,35,21,77,87,57,24,67,58,71,15,40,16,11,64,8,10,13,59,77,53,53,49,14,48,28,45,76,72,19,33,86,96,15,21,46,64,58,59,62,57,14,38,44,39,10,28,66,77,43,40,25,54,89,98,5,1,43,6,26,68,39,15,86,99,83],[68,59,19,13,18,48,82,66,97,56,77,28,89,12,80,26,57,91,43,61,55,32,11,84,84,22,13,24,23,7,79,30,57,3,48,7,87,29,17,63,27,38,13,81,86,69,39,83,3,75,12,85,58,59,97,4,39,90,90,14,54,89,96,65,49,32,54,95,63,8,18,92,81,97,65,38,31,42,44,69,74,25,21,29,29,98,15,59,69,20,89,62,14,77,63,4,35],[92,50,24,59,17,58,26,98,92,59,61,56,58,49,73,76,33,82,10,1,54,65,57,95,38,4,10,0,50,63,38,59,29,64,76,53,13,56,68,67,0,32,44,8,41,25,55,16,79,50,67,43,87,87,53,95,54,48,48,73,21,12,93,71,93,96,71,91,79,28,27,64,18,76,58,13,40,21,30,68,98,42,23,42,47,94,8,1,1,32,7,47,77,67,2,20,53],[25,99,19,87,83,35,88,28,54,99,14,86,91,47,72,92,2,80,97,85,45,70,44,8,74,3,56,87,27,28,56,81,17,73,83,26,67,79,15,7,64,87,95,56,77,46,69,99,38,49,26,34,21,34,49,73,4,60,78,45,96,49,11,49,34,6,2,32,18,68,74,43,48,62,24,9,95,90,47,29,25,10,11,16,25,25,23,61,27,35,7,90,70,89,17,65,37],[1,55,79,84,74,41,96,31,1,25,85,39,52,93,92,60,8,86,71,29,59,91,48,59,70,25,59,50,22,36,52,97,70,44,93,55,69,23,66,8,6,26,81,99,24,48,49,39,37,42,50,21,71,9,5,20,43,98,10,19,2,19,32,4,69,80,14,9,0,45,53,17,31,87,21,70,53,63,16,90,47,22,97,33,70,99,18,65,13,20,91,97,41,52,80,20,62],[78,65,50,95,34,84,0,35,1,67,41,80,26,61,77,49,56,88,6,75,12,86,23,32,49,9,17,93,7,11,46,94,40,94,0,68,50,17,2,42,22,33,30,17,67,84,55,91,67,60,55,15,74,28,2,84,16,20,26,88,33,18,22,95,41,74,53,85,15,26,31,72,75,75,43,71,47,77,97,77,67,45,77,70,61,70,70,29,0,49,96,94,34,46,35,59,97],[0,64,98,94,5,67,94,80,76,15,47,77,12,87,7,40,86,86,56,86,54,54,60,67,91,27,52,37,77,42,77,96,13,21,49,78,52,97,62,77,36,47,73,10,24,57,26,90,27,4,16,85,13,48,83,12,38,4,42,66,32,12,5,10,72,85,64,53,80,34,74,91,32,70,32,29,67,63,20,1,21,79,27,21,75,62,60,31,87,82,44,98,59,42,63,63,1],[19,27,27,49,2,69,64,39,96,77,87,95,48,91,48,15,9,64,59,80,60,58,47,25,53,5,57,62,71,23,35,77,79,11,57,83,33,87,85,29,53,95,15,93,37,10,69,61,96,12,30,84,0,29,14,53,61,14,62,37,34,54,22,39,9,68,26,98,14,12,11,75,50,56,71,78,38,17,51,84,35,43,78,7,4,94,7,70,23,35,10,39,70,59,76,68,42],[30,3,26,87,52,0,77,38,78,95,80,2,48,7,48,66,56,53,93,46,39,62,53,38,91,56,50,92,61,65,51,33,32,20,47,14,36,98,97,89,89,36,20,47,88,83,63,46,60,76,53,4,37,43,9,39,99,29,96,84,38,97,28,82,87,88,52,40,34,71,41,35,50,6,2,3,19,4,55,70,27,54,97,34,33,18,10,60,78,48,3,25,34,76,96,70,23]]
# Wrong 
# [[99, 3, 3], [100, 3, 3]]
# Time Limit Exceeded
# [[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],[64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,18],[63,120,121,122,123,124,125,126,127,128,129,130,131,132,133,80,19],[62,119,168,169,170,171,172,173,174,175,176,177,178,179,134,81,20],[61,118,167,208,209,210,211,212,213,214,215,216,217,180,135,82,21],[60,117,166,207,240,241,242,243,244,245,246,247,218,181,136,83,22],[59,116,165,206,239,264,265,266,267,268,269,248,219,182,137,84,23],[58,115,164,205,238,263,280,281,282,283,270,249,220,183,138,85,24],[57,114,163,204,237,262,279,288,289,284,271,250,221,184,139,86,25],[56,113,162,203,236,261,278,287,286,285,272,251,222,185,140,87,26],[55,112,161,202,235,260,277,276,275,274,273,252,223,186,141,88,27],[54,111,160,201,234,259,258,257,256,255,254,253,224,187,142,89,28],[53,110,159,200,233,232,231,230,229,228,227,226,225,188,143,90,29],[52,109,158,199,198,197,196,195,194,193,192,191,190,189,144,91,30],[51,108,157,156,155,154,153,152,151,150,149,148,147,146,145,92,31],[50,107,106,105,104,103,102,101,100,99,98,97,96,95,94,93,32],[49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33]]

class Solution:
    def pacificAtlantic(self, heights: List[List[int]]) -> List[List[int]]: # flow from the shore, So, every step can confirm something.
        res = []
        m, n = len(heights), len(heights[0])
        po_shores = [(0, i) for i in range(n)] + [(i, 0) for i in range(m)]
        ao_shores = [(m - 1, i) for i in range(n)] + [(i, n - 1) for i in range(m)]
        can_reach_po_set = set()
        can_reach_ao_set = set()
        x = {'shores': [po_shores, ao_shores], 'can_reach_set':[can_reach_po_set, can_reach_ao_set]}

        for i in range(2):
            shores = x['shores'][i]
            can_reach_set = x['can_reach_set'][i]
            for row, column in shores:
                def helper(row, column):
                    can_reach_set.add((row, column))
                    directions = [(0, 1), (1, 0), (0, -1), (-1, 0)]
                    for direction in directions:
                        d_row, d_column = direction
                        next_row, next_column = row + d_row, column + d_column
                        
                        if -1 < next_column < n and -1 < next_row < m and heights[row][column] <= heights[next_row][next_column] and (next_row, next_column) not in can_reach_set:
                            helper(next_row, next_column)
                helper(row, column)
        
        return can_reach_ao_set & can_reach_po_set



    # def pacificAtlantic(self, heights: List[List[int]]) -> List[List[int]]: # flow from a cell to all direction, check whether this
    #     res = []
    #     m, n = len(heights), len(heights[0])
    #     memo = [[[-1, -1] for _ in range(n)] for _ in range(m)]
    #     reached_po = 0
    #     reached_ao = 0
    #     def helper(row, column):
    #         nonlocal reached_po, reached_ao, visited
    #         if (row, column) in visited:
    #             return
    #         if memo[row][column][0] != -1:
    #             reached_po = memo[row][column][0] or reached_po
    #             reached_ao = memo[row][column][1] or reached_ao
    #             return


    #         directions = [(0, 1), (1, 0), (0, -1), (-1, 0)]
    #         visited.add((row, column))


    #         for direction in directions:
    #             d_row, d_column = direction
    #             next_row, next_column = row + d_row, column + d_column

    #             if next_column == n or next_row == m:
    #                 reached_ao = 1
    #             elif next_column == -1 or next_row == -1:
    #                 reached_po = 1
    #             elif heights[row][column] >= heights[next_row][next_column] and heights[next_row][next_column] != -1:
    #                 # temp = heights[row][column]
    #                 # heights[row][column] = -1
    #                 helper(next_row, next_column)
    #                 # heights[row][column] = temp

    #     for row in range(m):
    #         for column in range(n):
    #             reached_po = 0
    #             reached_ao = 0
    #             visited = set()

    #             # print('全部遍历，遍历到:', row, column)

    #             helper(row, column)

    #             # if row == 0 and column == 4:
    #             # print('真正用到:',reached_po, reached_ao)
    #             if reached_ao and reached_po:
    #                 res.append([row, column])
    #             memo[row][column] = [reached_po, reached_ao]
        
    #     return res




    # def pacificAtlantic(self, heights: List[List[int]]) -> List[List[int]]: # （aborted) ask neighbors, "can you go to pacific Ocean and Atlantic Ocean?", and combine the result as current cell's result.
    #     res = []
    #     m, n = len(heights), len(heights[0])
    #     # memo = [[[-1, -1]] * n ] * m # Pacific Ocean is the first value
    #     memo = [[[-1, -1] for _ in range(n)] for _ in range(m)] # Pacific Ocean is the first value
    #     isComplete = [[0 for _ in range(n)] for _ in range(m)]

    #     def helper(row, column):
    #         # print(row, column)
    #         # initiate memo, avoid neighbors go back to here
    #         memo[row][column] = [0, 0]

    #         directions = [(0, 1), (1, 0), (0, -1), (-1, 0)]

    #         for direction in directions:
    #             d_row, d_column = direction
    #             next_row, next_column = row + d_row, column + d_column

    #             if next_column == n or next_row == m:
    #                 memo[row][column][1] = 1
    #             elif next_column == -1 or next_row == -1:
    #                 memo[row][column][0] = 1
    #             elif heights[row][column] >= heights[next_row][next_column]:
    #                 # get data from neighbors
    #                 if isComplete[next_row][next_column] == 0:
    #                     helper(next_row, next_column)
    #                 memo[row][column][0] = memo[row][column][0] or memo[next_row][next_column][0]
    #                 memo[row][column][1] = memo[row][column][1] or memo[next_row][next_column][1]
            
    #         # make sure neighbors will receive data from current cell
    #         # for direction in directions:
    #         #     d_row, d_column = direction
    #         #     next_row, next_column = row + d_row, column + d_column
                
    #         #     if -1 < next_column < n and -1 < next_row < m:
                    
    #         #             # print('当前：', row, column)
    #         #             # print('下一个', next_row, next_column)

    #         #         if isComplete[row][column] == 1 and isComplete[next_row][next_column] == 0 and heights[row][column] == heights[next_row][next_column]:
    #         #             isComplete[next_row][next_column] = 1
    #         #             helper(next_row, next_column)
    #         #             # memo[next_row][next_column][0] = memo[row][column][0] or memo[next_row][next_column][0]
    #         #             # memo[next_row][next_column][1] = memo[row][column][1] or memo[next_row][next_column][1]

    #     for row in range(m):
    #         for column in range(n):
    #             if isComplete[row][column] == 0:
    #                 isComplete[row][column] = 1
    #                 helper(row, column)
    #             # helper(row, column)

    #             if memo[row][column][0] == 1 and memo[row][column][1] == 1:
    #                 res.append([row, column])
        
    #     # print(isComplete)
    #     return res


# @lc code=end

